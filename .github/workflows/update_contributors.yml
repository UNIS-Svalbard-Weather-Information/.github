name: Update Contributors

on:
  schedule:
    # Runs at 00:00 UTC every day
    - cron: '0 0 * * *'
  workflow_dispatch:  # Allows manual triggering
permissions:
  contents: write
jobs:
  update-contributors:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests

      - name: Fetch and update contributors
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ORG_NAME: ${{ github.repository_owner }}
        run: |
          python - <<EOF
          import os
          import requests

          org = os.getenv("ORG_NAME")
          token = os.getenv("GITHUB_TOKEN")
          headers = {"Authorization": f"token {token}"}

          # Fetch all repositories in the organization
          repos_url = f"https://api.github.com/orgs/{org}/repos?per_page=100"
          repos = requests.get(repos_url, headers=headers).json()

          contributors = set()

          for repo in repos:
              repo_name = repo["name"]
              contributors_url = f"https://api.github.com/repos/{org}/{repo_name}/contributors?per_page=100"
              response = requests.get(contributors_url, headers=headers)
              if response.status_code == 200:
                  for contributor in response.json():
                      contributors.add((contributor["login"], contributor["html_url"], contributor["avatar_url"]))

          # Generate markdown table
          with open("README.md", "w") as f:
              f.write("# Our Contributors\n\n")
              f.write("| Avatar | Username |\n|--------|----------|\n")
              for login, html_url, avatar_url in sorted(contributors):
                  f.write(f"| <img src='{avatar_url}' width='50'> | [{login}]({html_url}) |\n")
                  print(login)

          print(f"Updated README.md with {len(contributors)} contributors.")
          EOF

      - name: Commit and push changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add README.md
          git commit -m "Update contributors list" || echo "No changes to commit"
          git push
